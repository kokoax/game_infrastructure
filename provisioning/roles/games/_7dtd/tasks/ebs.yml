---
- name: Check volume device
  stat:
    path: /dev/sdh
  register: volume_device
- name: Attach ebs
  # NOTE: volume-idはawsでリソースを作ってからidを取ってきて変数に入れてください
  command: aws ec2 attach-volume --device /dev/sdh --volume-id {{ volume_id }} --instance-id {{ lookup('pipe', 'curl 169.254.169.254/latest/meta-data/instance-id/') }}
  when: not volume_device.stat.exists
- name: Pause after attach
  pause:
    seconds: 5
- name: Mount external EBS to /ebs
  mount:
    path: /home
    src: /dev/sdh
    fstype: xfs
    opts: defaults,noatime
    state: mounted
    dump: 1
    passno: 1
- name: Command df -T /dev/sdh
  command: df -T /dev/sdh
  register: df_result
- name: Format EBS
  command: mkfs -t xfs /dev/sdh
  when: volume_device.stat.exists and "devtmpfs" in df_result.stdout
